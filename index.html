<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Spotify Listening</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #controls { margin-bottom: 20px; text-align: center; }
    #heatmapDiv, #barChartDiv { width: 100%; max-width: 900px; margin: auto; }
    #topArtist { text-align: center; font-size: 1.2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Spotify Listening Calendar Heatmap</h1>

  <div id="controls">
    <label for="dateDropdown">Select a day in March 2024:</label>
    <select id="dateDropdown"></select>
  </div>

  <div id="heatmapDiv"></div>
  <div id="topArtist">Top artist of the day will appear here</div>
  <div id="barChartDiv"></div>

  <script>
    d3.csv("spotify_listening_history.csv", d3.autoType).then(function(data) {
      // Parse dates and prepare data
      data.forEach(d => {
        d.ts = new Date(d.ts);
        d.date = new Date(d.ts.getFullYear(), d.ts.getMonth(), d.ts.getDate());
        d.ms_played = +d.ms_played || 0;
        d.year = d.ts.getFullYear();
      });

      // Filter to March 2024 (note: JS months are 0-indexed)
      const march2024 = data.filter(d => d.year === 2024 && d.ts.getMonth() === 2);

      // Group by day (ISO format string)
      const groupedByDate = d3.group(march2024, d => d.date.toISOString().slice(0, 10));

      // Populate dropdown with available days
      const dropdown = d3.select("#dateDropdown");
      Array.from(groupedByDate.keys()).forEach(date => {
        dropdown.append("option").text(date).attr("value", date);
      });

      // Display top artist
      function updateTopArtist(selectedDate) {
        const plays = groupedByDate.get(selectedDate);
        if (!plays || plays.length === 0) {
          d3.select("#topArtist").text("No data for this day.");
          return;
        }

        const artistGroup = d3.rollup(
          plays,
          v => d3.sum(v, d => d.ms_played),
          d => d.master_metadata_album_artist_name
        );

        const sorted = Array.from(artistGroup.entries()).sort((a, b) => b[1] - a[1]);
        const topArtist = sorted[0];

        // conver topArtist[1] from ms to minutes
        topArtist[1] = Math.round(topArtist[1] / 60000);
        d3.select("#topArtist").html(
          `ðŸŽ§ <strong>${topArtist[0] || 'Unknown Artist'}</strong> was your top artist on <strong>${selectedDate}</strong> with ${topArtist[1]} minutes played.`
        );
      }

      // Display pie chart of top 3 artists
      function updatePieChart(selectedDate) {
        const plays = groupedByDate.get(selectedDate);
        if (!plays || plays.length === 0) return;

        const artistGroup = d3.rollup(
          plays,
          v => d3.sum(v, d => d.ms_played),
          d => d.master_metadata_album_artist_name
        );

        const sorted = Array.from(artistGroup.entries()).sort((a, b) => b[1] - a[1]);
        const topArtists = sorted.slice(0, 3);

        const labels = topArtists.map(d => d[0] || 'Unknown');
        const values = topArtists.map(d => d[1]);

        const pieData = [{
          labels: labels,
          values: values,
          type: "pie"
        }];

        Plotly.newPlot("barChartDiv", pieData, {
          title: "Top 3 Artists on " + selectedDate
        });
      }

      // Initial display
      const initialDate = dropdown.node().value;
      if (initialDate) {
        updateTopArtist(initialDate);
        updatePieChart(initialDate);
      }

      // Combined event listener
      dropdown.on("change", function() {
        const selectedDate = this.value;
        updateTopArtist(selectedDate);
        updatePieChart(selectedDate);
      });





    });
  </script>
</body>
</html>
